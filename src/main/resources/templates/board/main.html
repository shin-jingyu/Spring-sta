<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>

	<link th:replace="header.html" />

</head>

<body>


	<div class="sidebar">
		<div class="container">
			<p>home</p>
		</div>
	</div>


	<div class="content">
		<table class="table table-bordered">
			<thead>
				<tr>
					<th class="col-md-1">번호</th>
					<th class="col-md-1">제목</th>
					<th class="col-md-1">작성자</th>
					<th class="col-md-1">작성일</th>
				</tr>
			</thead>
			<tbody id="boardTableBody">

			</tbody>
		</table>

		<!-- 글작성 모달 -->
		<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#Modal"
			data-bs-whatever="@mdo">글작성</button>

		<div class="modal fade" id="Modal" tabindex="-1" aria-labelledby="ModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="ModalLabel">글작성</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>

					<div class="modal-body">
						<div class="mb-3">
							<label for="content" class="col-form-label">사진:</label>
							<input id="boardfile" type="file" multiple>
							<div id="carouselExampleIndicators" class="carousel slide">
								<div class="carousel-inner">
									<div id="imgdiv" class="carousel-item active" hidden>
										<img id="imagePreview1" class="d-block w-100" style="height: 300px;" src="">
										<input type="hidden" id="boardimg1" name="boardimg1" value="">
									</div>

								</div>


								<button class="carousel-control-prev" type="button"
									data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Previous</span>
								</button>
								<button class="carousel-control-next" type="button"
									data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
									<span class="carousel-control-next-icon" ariahidden="true"></span>
									<span class="visually-hidden">Next</span>
								</button>
							</div>

						</div>

						<div class="mb-3">
							<label for="content" class="col-form-label">내용:</label>
							<textarea class="form-control" id="content" required></textarea>
						</div>

					</div>


					<div class="modal-footer">
						<button type="button" id="createButton" class="btn btn-primary">업로드</button>
					</div>
				</div>
			</div>
		</div>


		<!-- 상세보기 모달------------------- -->
		<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="detailModalLabel">글 상세보기</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<!-- 상세 내용을 여기에 채웁니다. -->
					</div>
					<div class="modal-footer">
						<button type="button" id="editButton" class="btn btn-primary">수정</button>
						<button type="button" id="saveButton" class="btn btn-primary">저장</button>
						<button type="button" id="deleteButton" class="btn btn-primary">삭제</button>
					</div>
				</div>
			</div>
		</div>

	</div>


</body>

</html>
<script th:inline="javascript">
	$(document).ready(function () {
		// 서버 API의 URL 및 필요한 HTML 엘리먼트 가져오기
		var apiURL = '/api/board';
		var boardTableBody = $('#boardTableBody');
		var createModal = $('#Modal'); // 글 작성 모달
		var detailModal = $('#detailModal'); // 상세보기 모달
		var loggedInUserNickname = /*[[${nickname}]]*/'';
		const imageInput = $('#boardfile');



		// 페이지가 로드될 때 게시글 목록을 업데이트
		function updateBoardList() {
			$.get(apiURL, function (data) {
				boardTableBody.empty(); // 게시판 목록 초기화

				// 각 게시글에 대한 정보를 목록에 추가
				data.forEach(function (item) {
					boardTableBody.append(`
                    <tr>
                        <td>${item.boardid}</td>
                        <td><a href="#" class="show-details" data-boardid="${item.boardid}">${item.title}</a></td>
                        <td>${item.nickname}</td>
                        <td>${item.createdAt}</td>
                    </tr>
                `);
				});
			});
		}

		// 글 목록 업데이트 함수 호출 (페이지 로드 시)
		updateBoardList();

		// 글 작성 폼 처리
		$('#createButton').on('click', function () {
			let boardsimg = $('#boardimg1');
			if (boardsimg.val() === '') {
				alert("이미지를 업로드 해주세요")
				return;
			}

			var boardImages = [];
			for (let i = 1; i <= imageInput[0].files.length; i++) {
				const imagePath = $('#boardimg' + i).val();
				if (imagePath !== null && imagePath !== '') {
					boardImages.push(imagePath);
				} else {
					// 이미지가 없으면 루프 종료
					break;
				}
			}


			console.log(boardImages);

			$.ajax({
				url: apiURL,
				method: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({
					boardimgs: boardImages,
					content: $('#content').val()
				})
			})
				.done(function (response) {
					createModal.modal('hide');
					updateBoardList();
				})
				.fail(function (jqXHR, textStatus, errorThrown) {
					console.log(jqXHR.responseText);
					console.log(textStatus);
					console.log(errorThrown);
				});

		});

		imageInput.on("change", function () {
			var formData = new FormData();
			const carouselInner = $('.carousel-inner');
			let a = 0;
			for (let i = 0; i < imageInput[0].files.length; i++) {
				let file = imageInput[0].files[i];
				formData.append('files', file);
				a = i + 1;
				if (i >= 1) {
					carouselInner.append(
						`<div class="carousel-item">` +
						`<img id="imagePreview${a}" class="d-block w-100" style="height: 300px;" src="">` +
						`<input type="hidden" id="boardimg${a}" name="boardimg${a}" value="">` +
						`</div>`
					);

				} else if (i == 0) {
					let imgdiv = document.getElementById('imgdiv');
					imgdiv.removeAttribute("hidden");
				}

				let imagePreviewtem = document.getElementById('imagePreview' + a);
				imagePreviewtem.src = URL.createObjectURL(file);


			}

			// 서버로 이미지 업로드
			$.ajax({
				url: apiURL + '/boardimg',
				method: 'POST',
				processData: false,
				contentType: false,
				data: formData,
				success: function (uniqueFileNames) {
					for (let i = 0; i < uniqueFileNames.length; i++) {
						let boardsimg = $('#boardimg' + (i + 1));
						boardsimg.val(uniqueFileNames[i]);
					}
				},
				error: function (xhr, status, error) {
					console.error(error);
				}
			});

		});

		function showDetail(boardid) {
			$.get(apiURL + '/' + boardid, function (data) {
				var modalBody = detailModal.find('.modal-body');
				modalBody.empty();



				// 수정할 수 없는 input과 textarea를 추가
				var titleInput = $('<input>', {
					type: 'text',
					id: 'updatedTitle',
					value: data.title,
					disabled: 'true', // 수정 불가능하게 설정
				});
				var contentInput = $('<textarea>', {
					id: 'updatedContent',
					text: data.content,
					disabled: 'true', // 수정 불가능하게 설정
				});

				modalBody.append('<p><strong>제목:</strong></p>');
				modalBody.append(titleInput);
				modalBody.append('<p><strong>내용:</strong></p>');
				modalBody.append(contentInput);

				var editButton = $('#editButton');
				let saveButton = $('#saveButton');
				let deleteButton = $('#deleteButton');

				if (data.nickname === loggedInUserNickname) {
					// 글 작성자와 로그인한 사용자가 일치하면 수정 버튼 활성화
					editButton.prop('disabled', false);
					editButton.show(); // 수정 버튼 표시
					saveButton.hide();
					deleteButton.show();

				} else {
					// 수정할 권한이 없는 경우 수정 버튼 숨김
					editButton.prop('disabled', true);
					editButton.hide(); // 수정 버튼 숨김
					saveButton.hide();
					deleteButton.hide();
				}

				editButton.on('click', function () {
					titleInput.prop('disabled', false);
					contentInput.prop('disabled', false);
					editButton.hide();
					saveButton.show();
					deleteButton.hide();
				});


				// 게시글 수정하기 
				saveButton.on('click', function () {
					// titleInput 및 contentInput의 값을 가져오기
					var updatedTitle = titleInput.val();
					var updatedContent = contentInput.val();

					// JSON 데이터 생성
					var updatedData = {
						title: updatedTitle,
						content: updatedContent
					};

					// 서버로 데이터 전송
					$.ajax({
						type: 'PATCH',
						url: apiURL + '/' + boardid,
						contentType: 'application/json',
						data: JSON.stringify(updatedData),
						success: function (response) {
							// 성공 시 실행할 코드 (예: 모달 닫기, 목록 업데이트)
							detailModal.modal('hide');
							updateBoardList();
						},
						error: function (xhr, status, error) {
							// 오류 처리
							console.error(error);
						}
					});
				});

				deleteButton.on('click', function () {
					$.ajax({
						type: 'DELETE',
						url: apiURL + '/' + boardid,
						success: function (response) {
							// 성공 시 실행할 코드 (예: 모달 닫기, 목록 업데이트)
							detailModal.modal('hide');
							updateBoardList();
						},
						error: function (xhr, status, error) {
							// 오류 처리
							console.error(error);
						}
					});
				});


				detailModal.modal('show');
			});
		}


		// Modal 열기 버튼 클릭 이벤트 핸들러
		boardTableBody.on('click', '.show-details', function () {
			var boardid = $(this).data('boardid');
			showDetail(boardid);
		});
	});

</script>